-- DATABASE SCRIPTS 'encuesta_colegio', CREATE TABLES AND SEQUENCES

SET statement_timeout = 0;
SET lock_timeout = 0;
SET idle_in_transaction_session_timeout = 0;
SET transaction_timeout = 0;
SET client_encoding = 'UTF8';
SET standard_conforming_strings = on;
SELECT pg_catalog.set_config('search_path', '', false);
SET check_function_bodies = false;
SET xmloption = content;
SET client_min_messages = warning;
SET row_security = off;

SET default_tablespace = '';

SET default_table_access_method = heap;

-- Table admin_settings
CREATE TABLE public.admin_settings (
    id integer NOT NULL PRIMARY KEY,
    pin_code character varying(10) NOT NULL
);

ALTER TABLE public.admin_settings OWNER TO postgres;

CREATE SEQUENCE public.admin_settings_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

ALTER SEQUENCE public.admin_settings_id_seq OWNER TO postgres;
ALTER SEQUENCE public.admin_settings_id_seq OWNED BY public.admin_settings.id;
ALTER TABLE ONLY public.admin_settings ALTER COLUMN id SET DEFAULT nextval('public.admin_settings_id_seq'::regclass);

-- Table surveys
CREATE TABLE public.surveys (
    id uuid DEFAULT gen_random_uuid() NOT NULL PRIMARY KEY,
    title character varying(200) NOT NULL,
    description text,
    target_audience character varying(50) NOT NULL,
    access_link character varying(255) NOT NULL,
    expiration_date timestamp without time zone NOT NULL,
    is_active boolean DEFAULT true,
    created_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    evaluated_name character varying(150),
    subject character varying(100)

    CONSTRAINT chk_target_audience CHECK (target_audience IN ('ESTUDIANTE_A_DOCENTE', 'DOCENTE_A_DOCENTE')),
    CONSTRAINT expiration_date_future CHECK (expiration_date > created_at),
    CONSTRAINT unique_access_link UNIQUE (access_link)
);

ALTER TABLE public.surveys OWNER TO postgres;

-- Table questions
CREATE TABLE public.questions (
    id integer NOT NULL PRIMARY KEY,
    survey_id uuid,
    question_text text NOT NULL,
    question_type character varying(20) NOT NULL,
    order_index integer NOT NULL,
    category character varying(100),

    CONSTRAINT questions_survey_id_fkey FOREIGN KEY (survey_id) REFERENCES public.surveys(id) ON DELETE CASCADE,
    CONSTRAINT chk_question_type CHECK (question_type IN ('ESCALA_1_5', 'TEXTO', 'SI_NO', 'MULTIPLE_OPCIONES')),
    CONSTRAINT unique_question_order_per_survey UNIQUE (survey_id, order_index)
);

ALTER TABLE public.questions OWNER TO postgres;

CREATE SEQUENCE public.questions_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

ALTER SEQUENCE public.questions_id_seq OWNER TO postgres;
ALTER SEQUENCE public.questions_id_seq OWNED BY public.questions.id;
ALTER TABLE ONLY public.questions ALTER COLUMN id SET DEFAULT nextval('public.questions_id_seq'::regclass);

-- Table submissions
CREATE TABLE public.submissions (
    id integer NOT NULL PRIMARY KEY,
    survey_id uuid,
    submitted_at timestamp without time zone DEFAULT CURRENT_TIMESTAMP,
    general_comment text,

    CONSTRAINT submissions_survey_id_fkey FOREIGN KEY (survey_id) REFERENCES public.surveys(id) ON DELETE CASCADE
);

ALTER TABLE public.submissions OWNER TO postgres;

CREATE SEQUENCE public.submissions_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

ALTER SEQUENCE public.submissions_id_seq OWNER TO postgres;
ALTER SEQUENCE public.submissions_id_seq OWNED BY public.submissions.id;
ALTER TABLE ONLY public.submissions ALTER COLUMN id SET DEFAULT nextval('public.submissions_id_seq'::regclass);

-- Table answers
CREATE TABLE public.answers (
    id integer NOT NULL PRIMARY KEY,
    submission_id integer,
    question_id integer,
    answer_text text,
    answer_value numeric(4,1),

    CONSTRAINT answers_question_id_fkey FOREIGN KEY (question_id) REFERENCES public.questions (id) ON DELETE CASCADE,
    CONSTRAINT answers_submission_id_fkey FOREIGN KEY (submission_id) REFERENCES public.submissions (id) ON DELETE CASCADE,
    CONSTRAINT chk_answer_value CHECK (answer_value >= 0 AND answer_value <= 5)
);

ALTER TABLE public.answers OWNER TO postgres;

CREATE SEQUENCE public.answers_id_seq
    AS integer
    START WITH 1
    INCREMENT BY 1
    NO MINVALUE
    NO MAXVALUE
    CACHE 1;

ALTER SEQUENCE public.answers_id_seq OWNER TO postgres;
ALTER SEQUENCE public.answers_id_seq OWNED BY public.answers.id;
ALTER TABLE ONLY public.answers ALTER COLUMN id SET DEFAULT nextval('public.answers_id_seq'::regclass);